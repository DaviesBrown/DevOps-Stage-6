name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  workflow_dispatch:
    inputs:
      auto_approve:
        description: 'Auto approve terraform apply'
        required: false
        default: 'false'

env:
  TF_VERSION: '1.14.1'

jobs:
  drift-detection:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Check for Drift
        id: check
        run: |
          chmod +x infra/scripts/check_drift.sh
          infra/scripts/check_drift.sh
        env:
          TF_VAR_linode_token: ${{ secrets.LINODE_TOKEN }}
        continue-on-error: true

      - name: Send Drift Alert Email
        if: env.DRIFT_DETECTED == 'true'
        run: |
          chmod +x infra/scripts/send_email.sh
          infra/scripts/send_email.sh \
            "üö® Infrastructure Drift Detected - Action Required" \
            "Infrastructure drift has been detected in the TODO application.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}

          Drift Summary:
          ${{ env.DRIFT_SUMMARY }}

          Please review the changes and approve the deployment:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          This deployment is paused and awaiting manual approval."
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

  await-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: drift-detection
    if: needs.drift-detection.outputs.drift_detected == 'true'
    environment:
      name: production
    
    steps:
      - name: Wait for approval
        run: echo "‚è≥ Waiting for manual approval before applying changes..."

  terraform-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: [drift-detection, await-approval]
    if: |
      always() && 
      (needs.drift-detection.outputs.drift_detected == 'false' || 
       needs.await-approval.result == 'success')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Create terraform.tfvars
        run: |
          cd infra/terraform
          cat > terraform.tfvars <<EOF
          linode_token         = "${{ secrets.LINODE_TOKEN }}"
          linode_region        = "${{ secrets.LINODE_REGION }}"
          linode_type          = "g6-standard-2"
          root_pass            = "${{ secrets.LINODE_ROOT_PASS }}"
          ssh_public_key       = "${{ secrets.SSH_PUBLIC_KEY }}"
          domain               = "${{ secrets.DOMAIN }}"
          acme_email           = "${{ secrets.ACME_EMAIL }}"
          jwt_secret           = "${{ secrets.JWT_SECRET }}"
          github_repo          = "${{ github.server_url }}/${{ github.repository }}.git"
          github_token         = "${{ secrets.GH_TOKEN }}"
          ssh_private_key_path = "~/.ssh/id_rsa"
          EOF

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Terraform Apply
        run: |
          cd infra/terraform
          terraform apply -auto-approve
        env:
          TF_VAR_linode_token: ${{ secrets.LINODE_TOKEN }}

      - name: Send Success Notification
        if: success()
        run: |
          chmod +x infra/scripts/send_email.sh
          infra/scripts/send_email.sh \
            "‚úÖ Infrastructure Deployment Successful" \
            "Infrastructure has been successfully deployed on Linode.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

      - name: Send Failure Notification
        if: failure()
        run: |
          chmod +x infra/scripts/send_email.sh
          infra/scripts/send_email.sh \
            "‚ùå Infrastructure Deployment Failed" \
            "Infrastructure deployment has failed.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
