name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - 'infra/scripts/**'
  workflow_dispatch:
    inputs:
      auto_approve:
        description: 'Auto approve terraform apply (true/false)'
        required: false
        default: 'false'

env:
  PROJ_PATH: /root/DevOps-Stage-6
  TF_DIR: infra/terraform
  ANSIBLE_DIR: infra/ansible

jobs:
  drift-detection:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.check-drift.outputs.drift_detected }}
      drift_summary: ${{ steps.check-drift.outputs.drift_summary }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add provisioning server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.PROVISION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Drift Detection on Provisioning Server
        id: check-drift
        continue-on-error: true
        run: |
          set +e
          
          # Execute drift check on provisioning server
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash -s << 'ENDSSH'
            set -e
            
            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main
            
            echo "===== Running Drift Check Script ====="
            cd /root/DevOps-Stage-6
            
            chmod +x infra/scripts/check_drift.sh infra/scripts/send_email.sh
            
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            
            # Create a dummy GITHUB_ENV file since the script writes to it
            export GITHUB_ENV=/tmp/github_env_dummy
            touch $GITHUB_ENV
            
            infra/scripts/check_drift.sh
            CHECK_EXIT_CODE=$?
            
            rm -f $GITHUB_ENV
            
            if [ $CHECK_EXIT_CODE -eq 2 ]; then
              echo "DRIFT_DETECTED: Sending email notification..."
              
              export SMTP_HOST="${SMTP_HOST}"
              export SMTP_PORT="${SMTP_PORT}"
              export SMTP_USER="${SMTP_USER}"
              export SMTP_PASSWORD="${SMTP_PASSWORD}"
              export ALERT_EMAIL="${ALERT_EMAIL}"
              
              cd /root/DevOps-Stage-6/infra/scripts
              
              SUBJECT="ðŸš¨ Terraform Drift Detected - Approval Required"
              BODY="Infrastructure drift has been detected in your Terraform configuration.

Repository: ${GITHUB_REPO}
Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}
Triggered by: ${GITHUB_ACTOR}

Please review the drift details and approve the deployment in GitHub Actions.
Workflow run: ${GITHUB_RUN_URL}

The workflow is paused and waiting for your approval in the production environment.

Check the plan_output.txt artifact for detailed changes."
              
              ./send_email.sh "$SUBJECT" "$BODY"
              EMAIL_EXIT=$?
              
              if [ $EMAIL_EXIT -eq 0 ]; then
                echo "âœ… Email notification sent successfully"
              else
                echo "âš ï¸ Email notification failed with exit code: ${EMAIL_EXIT}"
              fi
            fi
            
            exit $CHECK_EXIT_CODE
          ENDSSH
          
          REMOTE_EXIT_CODE=$?
          
          if [ $REMOTE_EXIT_CODE -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            
            scp root@${{ secrets.PROVISION_SERVER_IP }}:/root/DevOps-Stage-6/infra/terraform/plan_output.txt ./plan_output.txt || echo "Could not retrieve plan output"
            
            if [ -f ./plan_output.txt ]; then
              SUMMARY=$(tail -n 50 ./plan_output.txt || echo "See plan_output.txt artifact for details")
              echo "drift_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
            
            echo "âœ… Drift detected. Email sent from provisioning server."
            exit 0
          elif [ $REMOTE_EXIT_CODE -eq 0 ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_summary=No infrastructure drift detected." >> $GITHUB_OUTPUT
            echo "âœ… No drift detected."
            exit 0
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "drift_summary=Terraform plan failed. Check logs for details." >> $GITHUB_OUTPUT
            echo "âŒ Drift detection failed."
            exit 1
          fi
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Drift Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-drift-plan
          path: plan_output.txt
          if-no-files-found: ignore

  await-approval:
    name: Await Manual Approval
    runs-on: ubuntu-latest
    needs: drift-detection
    if: needs.drift-detection.outputs.drift_detected == 'true'
    environment:
      name: production
    
    steps:
      - name: Awaiting Approval
        run: |
          echo "ðŸ”” Infrastructure drift detected!"
          echo ""
          echo "Drift Summary:"
          echo "${{ needs.drift-detection.outputs.drift_summary }}"
          echo ""
          echo "â¸ï¸  Workflow paused. Please review and approve in the GitHub UI to proceed."
          echo ""
          echo "An email notification has been sent with drift details."

  terraform-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: [drift-detection, await-approval]
    if: |
      always() &&
      needs.drift-detection.result == 'success' &&
      (
        needs.drift-detection.outputs.drift_detected == 'false' ||
        needs.await-approval.result == 'success' ||
        github.event.inputs.auto_approve == 'true'
      )
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add provisioning server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.PROVISION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Terraform Apply & Ansible on Provisioning Server
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} << 'EOF'
            set -e
            
            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main
            
            echo "===== Running Terraform Apply ====="
            cd infra/terraform
            
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            
            terraform init -input=false
            terraform apply -auto-approve
            
            echo "===== Running Ansible Deployment ====="
            cd ../ansible
            ansible-playbook -i inventory/hosts.ini playbook.yml
            
            echo "âœ… Infrastructure deployment completed successfully"
          EOF
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Send Success Notification
        if: success()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash -s << 'EOF'
            export SMTP_HOST="${SMTP_HOST}"
            export SMTP_PORT="${SMTP_PORT}"
            export SMTP_USER="${SMTP_USER}"
            export SMTP_PASSWORD="${SMTP_PASSWORD}"
            export ALERT_EMAIL="${ALERT_EMAIL}"
            
            cd /root/DevOps-Stage-6/infra/scripts
            
            SUBJECT="âœ… Infrastructure Deployment Successful"
            BODY="Infrastructure has been successfully deployed.

Repository: ${GITHUB_REPO}
Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}
Triggered by: ${GITHUB_ACTOR}

Deployment completed on: $(date)

View details: ${GITHUB_RUN_URL}"
            
            ./send_email.sh "$SUBJECT" "$BODY"
          EOF
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Failure Notification
        if: failure()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash -s << 'EOF'
            export SMTP_HOST="${SMTP_HOST}"
            export SMTP_PORT="${SMTP_PORT}"
            export SMTP_USER="${SMTP_USER}"
            export SMTP_PASSWORD="${SMTP_PASSWORD}"
            export ALERT_EMAIL="${ALERT_EMAIL}"
            
            cd /root/DevOps-Stage-6/infra/scripts
            
            SUBJECT="âŒ Infrastructure Deployment Failed"
            BODY="Infrastructure deployment has failed.

Repository: ${GITHUB_REPO}
Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}
Triggered by: ${GITHUB_ACTOR}

Failed at: $(date)

Please check the logs for details: ${GITHUB_RUN_URL}"
            
            ./send_email.sh "$SUBJECT" "$BODY"
          EOF
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
