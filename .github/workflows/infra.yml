name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - 'infra/scripts/**'
  workflow_dispatch:
    inputs:
      auto_approve:
        description: 'Auto approve terraform apply (true/false)'
        required: false
        default: 'false'

env:
  PROJ_PATH: /root/DevOps-Stage-6
  TF_DIR: infra/terraform
  ANSIBLE_DIR: infra/ansible

jobs:
  drift-detection:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.check-drift.outputs.drift_detected }}
      drift_summary: ${{ steps.check-drift.outputs.drift_summary }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROVISION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Drift Detection on Provisioning Server
        id: check-drift
        continue-on-error: true
        run: |
          set +e
          
          # Execute drift check on provisioning server
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash << 'ENDSSH'
            set -e
            
            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main
            
            echo "===== Running Drift Check Script ====="
            chmod +x infra/scripts/check_drift.sh infra/scripts/send_email.sh
            
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            export GITHUB_ENV=/tmp/github_env_dummy
            touch $GITHUB_ENV
            
            infra/scripts/check_drift.sh
            CHECK_EXIT_CODE=$?
            rm -f $GITHUB_ENV
            
            if [ $CHECK_EXIT_CODE -eq 2 ]; then
              echo "===== DRIFT DETECTED: Sending Email ====="
              echo "DEBUG: Current directory: $(pwd)"
              echo "DEBUG: Listing infra/scripts:"
              ls -la infra/scripts/
              
              export SMTP_HOST="${SMTP_HOST}"
              export SMTP_PORT="${SMTP_PORT}"
              export SMTP_USER="${SMTP_USER}"
              export SMTP_PASSWORD="${SMTP_PASSWORD}"
              export ALERT_EMAIL="${ALERT_EMAIL}"
              
              echo "DEBUG: SMTP Configuration:"
              echo "  SMTP_HOST: ${SMTP_HOST}"
              echo "  SMTP_PORT: ${SMTP_PORT}"
              echo "  SMTP_USER: ${SMTP_USER}"
              echo "  ALERT_EMAIL: ${ALERT_EMAIL}"
              
              if [ ! -f infra/scripts/send_email.sh ]; then
                echo "ERROR: send_email.sh not found at infra/scripts/send_email.sh"
                ls -R infra/
                exit 2
              fi
              
              chmod +x infra/scripts/send_email.sh
              
              SUBJECT="ðŸš¨ Terraform Drift Detected - Approval Required"
              BODY="Infrastructure drift detected in ${GITHUB_REPO}

Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}
Triggered by: ${GITHUB_ACTOR}

Approve the deployment here:
${GITHUB_RUN_URL}

The workflow is paused waiting for approval."
              
              echo "DEBUG: Calling send_email.sh with subject: $SUBJECT"
              cd infra/scripts
              echo "DEBUG: Changed to directory: $(pwd)"
              echo "DEBUG: About to execute: ./send_email.sh"
              
              set +e
              ./send_email.sh "$SUBJECT" "$BODY"
              EMAIL_STATUS=$?
              set -e
              
              echo "DEBUG: send_email.sh completed with exit code: $EMAIL_STATUS"
              
              if [ $EMAIL_STATUS -eq 0 ]; then
                echo "âœ… Email sent successfully"
              else
                echo "âŒ Email FAILED with exit code $EMAIL_STATUS"
                echo "ERROR: Email was not sent! Check SMTP credentials and send_email.sh script"
              fi
              
              cd /root/DevOps-Stage-6
            fi
            
            exit $CHECK_EXIT_CODE
          ENDSSH
          
          REMOTE_EXIT_CODE=$?
          
          if [ $REMOTE_EXIT_CODE -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            scp root@${{ secrets.PROVISION_SERVER_IP }}:/root/DevOps-Stage-6/infra/terraform/plan_output.txt ./plan_output.txt 2>/dev/null || true
            
            if [ -f ./plan_output.txt ]; then
              SUMMARY=$(tail -n 50 ./plan_output.txt || echo "See artifact")
              echo "drift_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "drift_summary=Drift detected - see logs" >> $GITHUB_OUTPUT
            fi
            
            echo "âœ… Drift detected. Email notification attempted."
            exit 0
          elif [ $REMOTE_EXIT_CODE -eq 0 ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_summary=No drift detected" >> $GITHUB_OUTPUT
            echo "âœ… No drift detected."
            exit 0
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "drift_summary=Drift check failed" >> $GITHUB_OUTPUT
            echo "âŒ Drift detection failed."
            exit 1
          fi
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Drift Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-drift-plan
          path: plan_output.txt
          if-no-files-found: ignore

  await-approval:
    name: Await Manual Approval
    runs-on: ubuntu-latest
    needs: drift-detection
    if: needs.drift-detection.outputs.drift_detected == 'true'
    environment:
      name: production
    
    steps:
      - name: Awaiting Approval
        run: |
          echo "ðŸ”” Infrastructure drift detected!"
          echo ""
          echo "Drift Summary:"
          echo "${{ needs.drift-detection.outputs.drift_summary }}"
          echo ""
          echo "â¸ï¸  Workflow paused. Approve in GitHub UI to proceed."

  terraform-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: [drift-detection, await-approval]
    if: |
      always() &&
      needs.drift-detection.result == 'success' &&
      (
        needs.drift-detection.outputs.drift_detected == 'false' ||
        needs.await-approval.result == 'success' ||
        github.event.inputs.auto_approve == 'true'
      )
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROVISION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Terraform Apply & Ansible
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash << 'EOF'
            set -e
            
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main
            
            cd infra/terraform
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            
            terraform init -input=false
            terraform apply -auto-approve
            
            cd ../ansible
            ansible-playbook -i inventory/hosts.ini playbook.yml
          EOF
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Send Success Notification
        if: success()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash << 'EOF'
            export SMTP_HOST="${SMTP_HOST}"
            export SMTP_PORT="${SMTP_PORT}"
            export SMTP_USER="${SMTP_USER}"
            export SMTP_PASSWORD="${SMTP_PASSWORD}"
            export ALERT_EMAIL="${ALERT_EMAIL}"
            
            cd /root/DevOps-Stage-6/infra/scripts
            ./send_email.sh \
              "âœ… Infrastructure Deployment Successful" \
              "Infrastructure deployed successfully.

Repository: ${GITHUB_REPO}
Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}

View details: ${GITHUB_RUN_URL}"
          EOF
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Failure Notification
        if: failure()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} bash << 'EOF'
            export SMTP_HOST="${SMTP_HOST}"
            export SMTP_PORT="${SMTP_PORT}"
            export SMTP_USER="${SMTP_USER}"
            export SMTP_PASSWORD="${SMTP_PASSWORD}"
            export ALERT_EMAIL="${ALERT_EMAIL}"
            
            cd /root/DevOps-Stage-6/infra/scripts
            ./send_email.sh \
              "âŒ Infrastructure Deployment Failed" \
              "Infrastructure deployment failed.

Repository: ${GITHUB_REPO}
Branch: ${GITHUB_REF}
Commit: ${GITHUB_SHA}

View details: ${GITHUB_RUN_URL}"
          EOF
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}            
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            
            # Create a dummy GITHUB_ENV file since the script writes to it
            export GITHUB_ENV=/tmp/github_env_dummy
            touch $GITHUB_ENV
            
            infra/scripts/check_drift.sh
            CHECK_EXIT_CODE=$?
            
            rm -f $GITHUB_ENV
            
            if [ $CHECK_EXIT_CODE -eq 2 ]; then
              echo "DRIFT_DETECTED: Sending email notification..."
              chmod +x /tmp/notify_drift.sh
              /tmp/notify_drift.sh \
                "${GITHUB_REPO}" \
                "${GITHUB_REF}" \
                "${GITHUB_SHA}" \
                "${GITHUB_ACTOR}" \
                "${GITHUB_RUN_URL}" \
                "${SMTP_HOST}" \
                "${SMTP_PORT}" \
                "${SMTP_USER}" \
                "${SMTP_PASSWORD}" \
                "${ALERT_EMAIL}"
            fi
            
            exit $CHECK_EXIT_CODE
          ENDSSH
          
          REMOTE_EXIT_CODE=$?
          
          if [ $REMOTE_EXIT_CODE -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            
            scp root@${{ secrets.PROVISION_SERVER_IP }}:/root/DevOps-Stage-6/infra/terraform/plan_output.txt ./plan_output.txt || echo "Could not retrieve plan output"
            
            if [ -f ./plan_output.txt ]; then
              SUMMARY=$(tail -n 50 ./plan_output.txt || echo "See plan_output.txt artifact for details")
              echo "drift_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
            
            echo "âœ… Drift detected. Email sent from provisioning server."
            exit 0
          elif [ $REMOTE_EXIT_CODE -eq 0 ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_summary=No infrastructure drift detected." >> $GITHUB_OUTPUT
            echo "âœ… No drift detected."
            exit 0
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "drift_summary=Terraform plan failed. Check logs for details." >> $GITHUB_OUTPUT
            echo "âŒ Drift detection failed."
            exit 1
          fi
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Drift Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-drift-plan
          path: plan_output.txt
          if-no-files-found: ignore

  await-approval:
    name: Await Manual Approval
    runs-on: ubuntu-latest
    needs: drift-detection
    if: needs.drift-detection.outputs.drift_detected == 'true'
    environment:
      name: production
    
    steps:
      - name: Awaiting Approval
        run: |
          echo "ðŸ”” Infrastructure drift detected!"
          echo ""
          echo "Drift Summary:"
          echo "${{ needs.drift-detection.outputs.drift_summary }}"
          echo ""
          echo "â¸ï¸  Workflow paused. Please review and approve in the GitHub UI to proceed."
          echo ""
          echo "An email notification has been sent with drift details."

  terraform-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: [drift-detection, await-approval]
    if: |
      always() &&
      needs.drift-detection.result == 'success' &&
      (
        needs.drift-detection.outputs.drift_detected == 'false' ||
        needs.await-approval.result == 'success' ||
        github.event.inputs.auto_approve == 'true'
      )
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add provisioning server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.PROVISION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Terraform Apply & Ansible on Provisioning Server
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} << 'EOF'
            set -e
            
            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main
            
            echo "===== Running Terraform Apply ====="
            cd infra/terraform
            
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            
            terraform init -input=false
            terraform apply -auto-approve
            
            echo "===== Running Ansible Deployment ====="
            cd ../ansible
            ansible-playbook -i inventory/hosts.ini playbook.yml
            
            echo "âœ… Infrastructure deployment completed successfully"
          EOF
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Send Success Notification
        if: success()
        run: |
          # Create success notification script
          cat > notify_success.sh << 'SUCCESSSCRIPT'
          #!/bin/bash
          export SMTP_HOST="$1"
          export SMTP_PORT="$2"
          export SMTP_USER="$3"
          export SMTP_PASSWORD="$4"
          export ALERT_EMAIL="$5"
          
          REPO="$6"
          BRANCH="$7"
          COMMIT="$8"
          ACTOR="$9"
          RUN_URL="${10}"
          
          SUBJECT="âœ… Infrastructure Deployment Successful"
          BODY="Infrastructure has been successfully deployed.

          Repository: ${REPO}
          Branch: ${BRANCH}
          Commit: ${COMMIT}
          Triggered by: ${ACTOR}

          Deployment completed on: $(date)

          View details: ${RUN_URL}"
          
          cd /root/DevOps-Stage-6/infra/scripts
          ./send_email.sh "$SUBJECT" "$BODY"
          SUCCESSSCRIPT
          
          chmod +x notify_success.sh
          scp notify_success.sh root@${{ secrets.PROVISION_SERVER_IP }}:/tmp/notify_success.sh
          
          ssh root@${{ secrets.PROVISION_SERVER_IP }} "/tmp/notify_success.sh \
            '${{ secrets.SMTP_HOST }}' \
            '${{ secrets.SMTP_PORT }}' \
            '${{ secrets.SMTP_USER }}' \
            '${{ secrets.SMTP_PASSWORD }}' \
            '${{ secrets.ALERT_EMAIL }}' \
            '${{ github.repository }}' \
            '${{ github.ref_name }}' \
            '${{ github.sha }}' \
            '${{ github.actor }}' \
            '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'"

      - name: Send Failure Notification
        if: failure()
        run: |
          # Create failure notification script
          cat > notify_failure.sh << 'FAILURESCRIPT'
          #!/bin/bash
          export SMTP_HOST="$1"
          export SMTP_PORT="$2"
          export SMTP_USER="$3"
          export SMTP_PASSWORD="$4"
          export ALERT_EMAIL="$5"
          
          REPO="$6"
          BRANCH="$7"
          COMMIT="$8"
          ACTOR="$9"
          RUN_URL="${10}"
          
          SUBJECT="âŒ Infrastructure Deployment Failed"
          BODY="Infrastructure deployment has failed.

          Repository: ${REPO}
          Branch: ${BRANCH}
          Commit: ${COMMIT}
          Triggered by: ${ACTOR}

          Failed at: $(date)

          Please check the logs for details: ${RUN_URL}"
          
          cd /root/DevOps-Stage-6/infra/scripts
          ./send_email.sh "$SUBJECT" "$BODY"
          FAILURESCRIPT
          
          chmod +x notify_failure.sh
          scp notify_failure.sh root@${{ secrets.PROVISION_SERVER_IP }}:/tmp/notify_failure.sh
          
          ssh root@${{ secrets.PROVISION_SERVER_IP }} "/tmp/notify_failure.sh \
            '${{ secrets.SMTP_HOST }}' \
            '${{ secrets.SMTP_PORT }}' \
            '${{ secrets.SMTP_USER }}' \
            '${{ secrets.SMTP_PASSWORD }}' \
            '${{ secrets.ALERT_EMAIL }}' \
            '${{ github.repository }}' \
            '${{ github.ref_name }}' \
            '${{ github.sha }}' \
            '${{ github.actor }}' \
            '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'"
