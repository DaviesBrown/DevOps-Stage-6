name: Infrastructure Deployment (Provisioning Server)

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  workflow_dispatch:
    inputs:
      auto_approve:
        description: 'Auto approve terraform apply'
        required: false
        default: 'false'

env:
  TF_VERSION: '1.14.0'

jobs:
  drift-detection:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROVISION_SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Run Drift Detection on Provisioning Server
        id: check
        continue-on-error: true
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} /bin/bash -s <<'REMOTE'
            set -e

            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main

            echo "===== Running Drift Detection ====="
            chmod +x infra/scripts/check_drift.sh
            infra/scripts/check_drift.sh || EXIT_CODE=$?

            # If drift detected, send email using the provisioning server's script
            if [ "$EXIT_CODE" == "2" ]; then
              echo "‚úã Drift detected, sending alert email..."
              chmod +x infra/scripts/send_email.sh
              /root/DevOps-Stage-6/infra/scripts/send_email.sh \
                "üö® Infrastructure Drift Detected" \
                "Infrastructure drift detected on provisioning server.

Repo: https://github.com/DaviesBrown/DevOps-Stage-6
Branch: main
Triggered by: GitHub Actions

Please review and approve deployment.

Drift summary:
$(cat infra/terraform/plan_output.txt | head -n 200)
"
            fi

            exit ${EXIT_CODE:-0}
REMOTE
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

  await-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: drift-detection
    if: needs.drift-detection.outputs.drift_detected == 'true'
    environment:
      name: production
    
    steps:
      - name: Await approval
        run: echo "‚è≥ Waiting for manual approval before applying changes..."

  terraform-apply:
    name: Apply Infrastructure & Run Ansible
    runs-on: ubuntu-latest
    needs: [drift-detection, await-approval]
    if: |
      always() && 
      (needs.drift-detection.outputs.drift_detected == 'false' || 
       needs.await-approval.result == 'success')
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROVISION_SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Run Terraform Apply & Ansible on Provisioning Server
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} /bin/bash -s <<'REMOTE'
            set -e

            echo "===== Pulling Latest Repo ====="
            cd /root/DevOps-Stage-6
            git fetch --all --prune
            git reset --hard origin/main

            echo "===== Running Terraform Apply ====="
            cd infra/terraform
            export TF_VAR_linode_token="${LINODE_TOKEN}"
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"

            terraform init -input=false
            terraform plan -out=tfplan.out
            terraform apply -auto-approve tfplan.out

            echo "===== Running Ansible Deployment ====="
            cd ../ansible
            ansible-playbook -i inventory/hosts.ini playbook.yml
REMOTE
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_OBJECT_STORAGE_SECRET_KEY }}

      - name: Send Success Notification
        if: success()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} "chmod +x /root/DevOps-Stage-6/infra/scripts/send_email.sh && /root/DevOps-Stage-6/infra/scripts/send_email.sh '‚úÖ Infrastructure Deployment Successful' 'Infrastructure has been successfully deployed on Linode.

Repo: https://github.com/DaviesBrown/DevOps-Stage-6
Branch: main
Commit: $GITHUB_SHA
'"

      - name: Send Failure Notification
        if: failure()
        run: |
          ssh root@${{ secrets.PROVISION_SERVER_IP }} "chmod +x /root/DevOps-Stage-6/infra/scripts/send_email.sh && /root/DevOps-Stage-6/infra/scripts/send_email.sh '‚ùå Infrastructure Deployment Failed' 'Infrastructure deployment has failed.

Repo: https://github.com/DaviesBrown/DevOps-Stage-6
Branch: main
Commit: $GITHUB_SHA
'"
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Create terraform.tfvars
        run: |
          cd infra/terraform
          cat > terraform.tfvars <<EOF
          linode_token         = "${{ secrets.LINODE_TOKEN }}"
          linode_region        = "${{ secrets.LINODE_REGION }}"
          linode_type          = "g6-standard-2"
          root_pass            = "${{ secrets.LINODE_ROOT_PASS }}"
          ssh_public_key       = "${{ secrets.SSH_PUBLIC_KEY }}"
          domain               = "${{ secrets.DOMAIN }}"
          acme_email           = "${{ secrets.ACME_EMAIL }}"
          jwt_secret           = "${{ secrets.JWT_SECRET }}"
          github_repo          = "${{ github.server_url }}/${{ github.repository }}.git"
          github_token         = "${{ secrets.GH_TOKEN }}"
          ssh_private_key_path = "~/.ssh/id_rsa"
          EOF

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.LINODE_OBJECT_STORAGE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.LINODE_OBJECT_STORAGE_SECRET_KEY }}

      - name: Terraform Apply
        run: |
          cd infra/terraform
          terraform apply -auto-approve
        env:
          TF_VAR_linode_token: ${{ secrets.LINODE_TOKEN }}

      - name: Send Success Notification
        if: success()
        run: |
          chmod +x infra/scripts/send_email.sh
          infra/scripts/send_email.sh \
            "‚úÖ Infrastructure Deployment Successful" \
            "Infrastructure has been successfully deployed on Linode.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

      - name: Send Failure Notification
        if: failure()
        run: |
          chmod +x infra/scripts/send_email.sh
          infra/scripts/send_email.sh \
            "‚ùå Infrastructure Deployment Failed" \
            "Infrastructure deployment has failed.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
